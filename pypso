#!/usr/bin/python
# Filename : pypso
# Author : Janne Toivola, OH2GXN
# $Id$

# nuts and bolts
import sys
import argparse
import numpy

# GUI and plots
import Tkinter
import tkFileDialog
import tkSimpleDialog
import pylab
from matplotlib.backends.backend_tkagg import FigureCanvasTkAgg, NavigationToolbar2TkAgg

# Yagi-specific stuff
from yagi import *

class MainWindow:
    '''The main window.'''

    def __init__(self, master, initial=None):
        # current state
        self.currentBest = initial
        self.swarm  = None
        self.swarmX = None
        self.swarmV = None

        # GUI stuff
        self.root = master
        self.__setMenus(master)
        self.__setWindow(master)

    def __setMenus(self, master):
        # menu bar
        self.menu = Tkinter.Menu(master)
        master.config(menu=self.menu)

        # File submenu
        self.fileMenu = Tkinter.Menu(self.menu)
        self.menu.add_cascade(label="File", menu=self.fileMenu)
        self.fileMenu.add_command(label="New...", 
                                  command=self.newYagi)
        self.fileMenu.add_command(label="Load initial...", 
                                  command=self.loadYagi)
        self.fileMenu.add_command(label="Save...",
                                  command=self.saveYagi)
        self.fileMenu.add_command(label="Export NEC...",
                                  command=self.exportYagi)
        self.fileMenu.add_command(label="Quit!", 
                                  command=self.quit)

        # Settings submenu
        self.setMenu = Tkinter.Menu(self.menu)
        self.menu.add_cascade(label="Settings", menu=self.setMenu)
        self.setMenu.add_command(label="About", 
                                 command=self.about)
        # TODO...


    def __setWindow(self, master):
        # a frame for all the stuff
        self.frame = Tkinter.Frame(master)
        self.frame.bind("<Return>", self.next) # Press enter to simulate a new set of antennas
        self.frame.pack()

        # TODO: various GUI components


    def quit(self):
        '''Does some clean-up and quits the program.'''
        # TODO: save something to a file?
        sys.stderr.write('Bye.')
        self.root.quit()
        self.root.destroy()

    def report(self, message):
        '''Sets the status bar.'''
        self.statusBar.configure(text=message)
        self.statusBar.update_idletasks()


    def randomize(self, N, sigma):
        '''Takes the best design and produces a swarm of N perturbed versions of it.'''
        if self.currentBest is None:
            self.loadYagi()
        vector = self.currentBest.toVector()
        M = vector.shape[0]
        self.swarmX = numpy.zeros((N, M), numpy.float)
        self.swarmV = numpy.zeros((N, M), numpy.float)
        self.swarmX[0,:] = vector
        self.swarmV[0,:] = numpy.zeros_like(vector)
        self.swarm = [self.currentBest]
        for n in range(1,N):
            anotherX = numpy.zeros_like(vector)
            anotherV = numpy.zeros_like(vector)
            for m in range (0,M):
                anotherX[m] = 1.0 * numpy.randn(0,sigma) * vector[m]
                anotherV[m] = 0.1 * numpy.randn(0,sigma) * vector[m]
            self.swarmX[n,:] = anotherX
            self.swarmV[n,:] = anotherV
            self.swarm.append(self.currentBest.fromVector(anotherX))


    def next(self):
        '''Evaluates the current swarm of designs and performs one step of
        Particle Swarm Optimization.'''
        # TODO: parallel execution?
        N = self.swarm.shape[0]
        evaluations = numpy.zeros(N, numpy.float)
        bestVal = 0
        bestInd = 0
        for n in range(0,N):
            current = self.swarm[n].evaluate() # TODO: criterion?
            evaluations[n] = current
            if current > bestVal:
                bestVal = current
                bestInd = n
        # TODO: accelerate swarmV towards n (gravitation)
        # TODO: update swarmX by swarmV
        # TODO: update swarm from swarmX


if __name__ == '__main__':
    # TODO: proper argument parsing for loading an initial antenna design
    for i in sys.argv[1:]:
        sys.stderr.write('ignored command line argument %s' % i)
        
    # the root widget
    root = Tkinter.Tk()
    root.title('PyPSO 0.1')
    
    # instance of our application
    win = MainWindow(root)
    
    # start the Tkinter event loop
    root.mainloop()

else:
    sys.stderr.write('NOTE: %s was not meant to be imported.\n' % __name__)
